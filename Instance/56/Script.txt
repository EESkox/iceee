#name Wailing_Crypt_Instance
#speed 100
#queue_jumps call
#flag report_all 1

#symbol CDEF_WAILER 1259
#symbol CDEF_BRAZIER 7777

#location LOC_WAILER_ROOM  1859 2702  2393 3234
#location_br LOC_BRAZIER_1  1916 3053 140
#location_br LOC_BRAZIER_2  1916 2874 140

;quick warp coords for boss room: /warp 2100 2900

set SEARCHARG 0
set ITERATOR 0
set TEMPRES 0
set TEMPSIZE 0
set TEMPCID 0
set TEMPCDEF 0
set MESG 0

set TEMP 0
set TEMP_TARGET 0

set CID_WAILER 0
set BRAZIER_1_RANGE 0
set BRAZIER_2_RANGE 0

set STAGE 0

; Just need this label, the entry point for instance scripts.
:init
	queue_event "eventWailerSearch" 5000

:main
	exec_queue
	wait 100
	goto main

;
; When the wailer dies, remove all of his minions and stop checking his
; health
;

:onKill_1259
	set STAGE 99
	call killMinions
	return

;
; Alabaster killed, spawn the flame on one of the braziers.
; The flame is the creature that has the purge ability. The
; ability will only be activated if both braziers are lit.
;
:onKill_3649
    spawn 1126558
    call brazierSearch
    return

;
; Kyshf killed, spawn the flame on one of the braziers.
; The flame is the creature that has the purge ability. The
; ability will only be activated if both braziers are lit.
;  
:onKill_3648
	spawn 1126556
	call brazierSearch
	return

:findResultArrayCDEF
	pop SEARCHARG
	set ITERATOR 0
	iarrsize RESULTARRAY TEMPSIZE
	if ITERATOR < TEMPSIZE
  		iarrvalue RESULTARRAY ITERATOR TEMPCID
		get_cdef TEMPCID TEMPRES
		if TEMPRES = SEARCHARG
			pushvar TEMPCID
			return
  		endif
  		inc ITERATOR
  		recompare
	endif
	pushint 0
	return

;
; The adds should now be spawned, but we need them
; to target whoever is attacking The Wailer and start
; attacking them.;

:activateMinions
	pop TARGET
	set ITERATOR 0
	iarrsize RESULTARRAY TEMPSIZE
	if ITERATOR < TEMPSIZE
	  iarrvalue RESULTARRAY ITERATOR TEMPCID
	  if TEMPCID != CID_WAILER
	      if MESG = 0
	          chat "conRed" "Instance" "Come my guardians, deal with these pests!"
	      	  set MESG 1
	      endif
	      get_cdef TEMPCID TEMPRES
	      set_target TEMPCID TARGET
		  ai_script_jump TEMPCID "tryMelee"
	  endif
	  inc ITERATOR
	  recompare
	endif
	return

;
; Find a CID in an array. Expects RESULTARRAY to
; be the array, and whatever is on top of the
; stack is what to search for. If it is in the
; the array, it will pushed back onto the stack
; otherwise zero will be returned.
;
; TODO should this be a script function?
;

:findResultArrayCID
	pop SEARCHARG
	set ITERATOR 0
	iarrsize RESULTARRAY TEMPSIZE
	if ITERATOR < TEMPSIZE
		iarrvalue RESULTARRAY ITERATOR TEMPCID
		if TEMPCID = SEARCHARG
			pushvar TEMPCID
			return
		endif
		inc ITERATOR
		recompare
	endif
	pushint 0
	return

;
; Search the room for the braziers. When they are found
; we get their CID, which can be used for targeting and
; calling AI scripts
;

:brazierSearch
	scan_npc_cid LOC_WAILER_ROOM RESULTARRAY
	pushint CDEF_BRAZIER
	call findResultArrayCDEF
	pop CID_BRAZIER1
	pushint CDEF_BRAZIER
	call findResultArrayCDEF
	pop CID_BRAZIER2

;
; Periodically search the room for the wailer. When 
; found, start monitoring is health.
;

:eventWailerSearch
	if CID_WAILER != 0
	  return
	endif
	scan_npc_cid LOC_WAILER_ROOM RESULTARRAY
	pushint CDEF_WAILER
	call findResultArrayCDEF
	pop CID_WAILER
	
	if CID_WAILER = 0
	  queue_event "eventWailerSearch" 5000
	  return
	else
	  call brazierSearch
	  queue_event "eventWailerHealth" 2000
	endif
	return

;
; 
; 

:eventWailerShield
	if CID_WAILER = 0
	  return
	endif	
	
	call tryCastShield
	
	if CID_BRAZIER1 != 0
		if CID_BRAZIER2 != 0
			set_target CID_BRAZIER1 CID_WAILER	      
			ai_script_jump CID_BRAZIER1 "tryWarm"
			set_target CID_BRAZIER2 CID_WAILER	
			ai_script_jump CID_BRAZIER2 "tryWarm"
		endif
	endif
	
	return

;
; Monitors the wailers health, and performs certain actions when
; he reaches various levels of health
;

:eventWailerHealth
	if CID_WAILER = 0
		return
	endif
	
	if STAGE = 99
		set STAGE 0
		
		;
		; TO HELP DEVELOPMENT, START SEARCHING FOR A WAILER SO WE
		; CAN GO AGAIN
		;
		
		queue_event "eventWailerSearch" 5000
		return
	endif
	
	get_health_percent CID_WAILER TEMP
	
	if STAGE != 0
		if TEMP = 100	
			;
			; If we have past the first phase, and the wailer returns to full health
			; dismiss the adds and return to the waiting for the first phase
			;				
	    	call killMinions
	    	set STAGE 0
			queue_event "eventWailerHealth" 3000
			return
		endif
	endif
	
	;
	; 80% The Wailer calls 3 forgotten souls to fight the group. 
	;
	
	if STAGE = 0
		if TEMP <= 80
			print ":at 80!"
			call spawnMinions
	    	set STAGE 1
	  	endif
	  	queue_event "eventWailerHealth" 3000
	  	return
	endif
	
	;
	; Between 60 and 70 % The Wailer casts his shield, 10k damage absorption, the group has to draw 
	; The Wailer to one of the two braziers to purge the shield
	;
	
	if STAGE = 1
		if TEMP <= 70
			set STAGE 2
		  	queue_event "eventWailerHealth" 3000
		  	return
		endif	
	endif
	
	;
	; 60% The Wailer calls 3 more forgotten souls to fight the group. 
	;
	
	if STAGE = 2
	
	  	queue_event "eventWailerShield" 2000
	  	
		if TEMP <= 60
			call spawnMinions
	    	set STAGE 3
	  	endif
	  	
	  	queue_event "eventWailerHealth" 3000
	  	return
	endif
	
	
	;
	; Between 40 and 50 % The Wailer casts his shield, 10k damage absorption, the group has to draw 
	; The Wailer to one of the two braziers to purge the shield
	;
	
	if STAGE = 3
		if TEMP <= 50
			set STAGE 4
	  	
		  	queue_event "eventWailerHealth" 3000
		  	return
		endif	
	endif
	
	;
	; 40% The Wailer calls 3 more forgotten souls to fight the group. 
	;
	
	if STAGE = 4
	
	  	queue_event "eventWailerShield" 2000
	  	
		if TEMP <= 40
			call spawnMinions
	    	set STAGE 5
	  	endif
	  	
	  	queue_event "eventWailerHealth" 3000
	  	return
	endif
	
	
	;
	; Between 20 and 30 % The Wailer casts his shield, 10k damage absorption, the group has to draw 
	; The Wailer to one of the two braziers to purge the shield
	;
	
	if STAGE = 5
		if TEMP <= 30
			set STAGE 6
	  	
		  	queue_event "eventWailerHealth" 3000
		  	return
		endif	
	endif
	
	
	;
	; 20% The Wailer calls 3 more forgotten souls to fight the group. 
	;
	if STAGE = 6
	
	  	queue_event "eventWailerShield" 2000
	  	
		if TEMP <= 20
			call spawnMinions
	    	set STAGE 7
	  	endif
	  	
	  	queue_event "eventWailerHealth" 3000
	  	return
	endif
	
	;
	; Between 0 and 10 % The Wailer casts his shield, 10k damage absorption, the group has to draw 
	; The Wailer to one of the two braziers to purge the shield
	;
	
	if STAGE = 7
		if TEMP <= 10
			set STAGE 8
	  	
		  	queue_event "eventWailerHealth" 3000
		  	return
		endif	
	endif
	
	if STAGE = 8
	  	queue_event "eventWailerShield" 2000
	endif
	
	;
	; Queue another wailer health check in 3 seconds
	;
		
	print "loop :eventWailerHealth"
	queue_event "eventWailerHealth" 3000
	  
	return


:tryCastShield
	ai_script_jump CID_WAILER "extTryCastShield"
	return

:killMinions
	despawn 1127142
	despawn 1127141
	despawn 1127140
	return

;
; Spawn 3 minions and search for their CID. activateMinions
; will then be called to make them target whoever is attacking
; the Wailer and start attacking them
;

:spawnMinions
	spawn_at 1127142 7778
	spawn_at 1127141 7778
	spawn_at 1127140 7778
	set MESG 0
	get_target CID_WAILER TEMP_TARGET
	printvar TEMP_TARGET
	scan_npc_cid LOC_WAILER_ROOM RESULTARRAY
	pushvar TEMP_TARGET
	call activateMinions
	return
