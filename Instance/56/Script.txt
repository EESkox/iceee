#name Wailing_Crypt_Instance
#speed 100
#queue_jumps call
#flag report_all 1

#symbol CDEF_WAILER 1259
#symbol CDEF_BRAZIER 7777

#location LOC_WAILER_ROOM  1859 2702  2393 3234
#location_br LOC_BRAZIER_1  1916 3053 140
#location_br LOC_BRAZIER_2  1916 2874 140

;quick warp coords for boss room: /warp 2100 2900

set SEARCHARG 0
set ITERATOR 0
set TEMPRES 0
set TEMPSIZE 0
set TEMPCID 0
set TEMPCDEF 0
set MESG 0

set TEMP 0
set TEMP_TARGET 0

set CID_WAILER 0
set BRAZIER_1_RANGE 0
set BRAZIER_2_RANGE 0
set SHIELD_CAST 0

set STAGE 0

; Just need this label, the entry point for instance scripts.
:init
	queue_event "eventWailerSearch" 5000

:main
	exec_queue
	wait 100
	goto main

;
; When the wailer dies, remove all of his minions and stop checking his
; health
;

:onKill_1259
	set STAGE 99
	print "Killed!"
	call killMinions
	return

:onKill_3649
	print "Alabaster killed, spawining brazier flame"
    spawn 1126558
    call brazierSearch
    return
   
:onKill_3648
	print "KYHYSYSHSF killed, spawining brazier flame"
	spawn 1126556
	call brazierSearch
	return

:findResultArrayCDEF
	print ":findResultArrayCDEF"
	pop SEARCHARG
	set ITERATOR 0
	iarrsize RESULTARRAY TEMPSIZE
	if ITERATOR < TEMPSIZE
  		iarrvalue RESULTARRAY ITERATOR TEMPCID
		get_cdef TEMPCID TEMPRES
		if TEMPRES = SEARCHARG
			pushvar TEMPCID
			return
  		endif
  		inc ITERATOR
  		recompare
	endif
	pushint 0
	return

:activateMinions
	pop TARGET
	print "!!target is"
	printvar TARGET
	print "!!wailer is"
	printvar CID_WAILER
	set ITERATOR 0
	iarrsize RESULTARRAY TEMPSIZE
	if ITERATOR < TEMPSIZE
	  print "!!TEMPCID is"
	  printvar TEMPCID
	  iarrvalue RESULTARRAY ITERATOR TEMPCID
	  if TEMPCID != CID_WAILER
	      if MESG = 0
	          chat "conRed" "Instance" "Come my guardians, deal with these pests!"
	      	  set MESG 1
	      endif
	      get_cdef TEMPCID TEMPRES
	      print "!!doing 1 target"
	      printvar TEMPRES
	      set_target TEMPCID TARGET
	      print "!!jumping 1 target"
		  ai_script_jump TEMPCID "tryMelee"
		  print "!!incing 1 target"
	  endif
	  inc ITERATOR
	  recompare
	endif
	return

:findResultArrayCID
	print ":findResultArrayCID"
	pop SEARCHARG
	set ITERATOR 0
	iarrsize RESULTARRAY TEMPSIZE
	if ITERATOR < TEMPSIZE
	  iarrvalue RESULTARRAY ITERATOR TEMPCID
	  if TEMPCID = SEARCHARG
	    pushvar TEMPCID
	    return
	  endif
	  inc ITERATOR
	  recompare
	endif
	pushint 0
	return

:brazierSearch
	print "Searching for braziers"
	scan_npc_cid LOC_WAILER_ROOM RESULTARRAY
	pushint CDEF_BRAZIER
	call findResultArrayCDEF
	pop CID_BRAZIER1
	print "CID brazier1"
	printvar CID_BRAZIER1
	pushint CDEF_BRAZIER
	call findResultArrayCDEF
	pop CID_BRAZIER2
	print "CID brazier2"
	printvar CID_BRAZIER2

:eventWailerSearch
	print ":eventWailerSearch"
	if CID_WAILER != 0
	  return
	endif
	scan_npc_cid LOC_WAILER_ROOM RESULTARRAY
	printvar CDEF_WAILER
	printintarr RESULTARRAY
	pushint CDEF_WAILER
	call findResultArrayCDEF
	pop CID_WAILER
	
	if CID_WAILER = 0
	  print ":no wailer!"
	  queue_event "eventWailerSearch" 5000
	  return
	else
	  print ":found wailer!"
	  call brazierSearch
	  queue_event "eventWailerHealth" 2000
	endif
	return


:eventWailerShield
	if CID_WAILER = 0
	  return
	endif	
	
	if SHIELD_CAST = 0
		call tryCastShield
	endif
	
	print "TRY WARM"
	printvar CID_BRAZIER1
	
	set_target CID_BRAZIER1 CID_WAILER	      
	ai_script_jump CID_BRAZIER1 "tryWarm"
	print "TRY WARM2"
	printvar CID_BRAZIER2
	
	set_target CID_BRAZIER2 CID_WAILER	
	ai_script_jump CID_BRAZIER2 "tryWarm"
	
	;scan_npc_cid LOC_BRAZIER_1 RESULTARRAY
	;pushint CDEF_WAILER
	;call findResultArrayCID
	;pop BRAZIER_1_RANGE
	
	;scan_npc_cid LOC_BRAZIER_2 RESULTARRAY
	;pushint CDEF_WAILER
	;call findResultArrayCID
	;pop BRAZIER_2_RANGE
	
	;set TEMP 0
	;if BRAZIER_1_RANGE = 0
	  ;inc TEMP
	;endif
	;if BRAZIER_2_RANGE = 0
	 ; inc TEMP
	;endif
	;if TEMP > 0
	 ; call tryCastShield
	;endif
	
	return

;
; Monitors the wailers health, and performs certain actions when
; he reaches various levels of health
;

:eventWailerHealth
	if CID_WAILER = 0
		return
	endif
	print ":eventWailerHealth"
	printvar STAGE
	
	if STAGE = 99
		set STAGE 0
		
		;
		; TO HELP DEVELOPMENT, START SEARCHING FOR A WAILER SO WE
		; CAN GO AGAIN
		;
		
		queue_event "eventWailerSearch" 5000
		return
	endif
	
	get_health_percent CID_WAILER TEMP
	printvar TEMP
	
	if STAGE != 0
		if TEMP = 100	
			;
			; If we have past the first phase, and the wailer returns to full health
			; dismiss the adds and return to the waiting for the first phase
			;				
	    	call killMinions
	    	set STAGE 0
			queue_event "eventWailerHealth" 3000
			return
		endif
	endif
	
	;
	; 80% The Wailer calls 3 forgotten souls to fight the group. 
	;
	
	if STAGE = 0
		if TEMP <= 80
			print ":at 80!"
			call spawnMinions
	    	set STAGE 1
	  	endif
	  	queue_event "eventWailerHealth" 3000
	  	return
	endif
	
	;
	; Between 60 and 70 % The Wailer casts his shield, 10k damage absorption, the group has to draw 
	; The Wailer to one of the two braziers to purge the shield
	;
	
	if STAGE = 1
		print "stage 1"
		print TEMP
		if TEMP <= 70
			print "Time for a shield"
			set STAGE 2
			set SHIELD_CAST 0
	  	
		  	queue_event "eventWailerHealth" 3000
		  	return
		endif	
	endif
	
	;
	; 60% The Wailer calls 3 more forgotten souls to fight the group. 
	;
	
	if STAGE = 2
	
	  	queue_event "eventWailerShield" 2000
	  	
		if TEMP <= 60
			print ":at 60!"
			call spawnMinions
	    	set STAGE 3
	  	endif
	  	
	  	queue_event "eventWailerHealth" 3000
	  	return
	endif
	
	
	;
	; Between 40 and 50 % The Wailer casts his shield, 10k damage absorption, the group has to draw 
	; The Wailer to one of the two braziers to purge the shield
	;
	
	if STAGE = 3
		if TEMP <= 50
			print "Time for a shield"
			set STAGE 4
			set SHIELD_CAST 0
	  	
		  	queue_event "eventWailerHealth" 3000
		  	return
		endif	
	endif
	
	;
	; 40% The Wailer calls 3 more forgotten souls to fight the group. 
	;
	
	if STAGE = 4
	
	  	queue_event "eventWailerShield" 2000
	  	
		if TEMP <= 40
			print ":at 40!"
			call spawnMinions
	    	set STAGE 5
	  	endif
	  	
	  	queue_event "eventWailerHealth" 3000
	  	return
	endif
	
	
	;
	; Between 20 and 30 % The Wailer casts his shield, 10k damage absorption, the group has to draw 
	; The Wailer to one of the two braziers to purge the shield
	;
	
	if STAGE = 5
		if TEMP <= 30
			print "Time for a shield"
			set STAGE 6
			set SHIELD_CAST 0
	  	
		  	queue_event "eventWailerHealth" 3000
		  	return
		endif	
	endif
	
	
	;
	; 20% The Wailer calls 3 more forgotten souls to fight the group. 
	;
	if STAGE = 6
	
	  	queue_event "eventWailerShield" 2000
	  	
		if TEMP <= 20
			print ":at 20!"
			call spawnMinions
	    	set STAGE 7
	  	endif
	  	
	  	queue_event "eventWailerHealth" 3000
	  	return
	endif
	
	;
	; Between 0 and 10 % The Wailer casts his shield, 10k damage absorption, the group has to draw 
	; The Wailer to one of the two braziers to purge the shield
	;
	
	if STAGE = 7
		if TEMP <= 10
			print "Time for a shield"
			set STAGE 8
			set SHIELD_CAST 0
	  	
		  	queue_event "eventWailerHealth" 3000
		  	return
		endif	
	endif
	
	if STAGE = 8
	  	queue_event "eventWailerShield" 2000
	endif
	
	;
	; Queue another wailer health check in 3 seconds
	;
		
	print "loop :eventWailerHealth"
	queue_event "eventWailerHealth" 3000
	  
	return


:tryCastShield
	print "Casting shield"
	ai_script_jump CID_WAILER "extTryCastShield"
	set SHIELD_CAST 1
	return

:killMinions
	print ":killMinions"
	despawn 1127142
	despawn 1127141
	despawn 1127140
	return

:spawnMinions
	print ":spawnMinions"
	spawn_at 1127142 0
	spawn_at 1127141 0
	spawn_at 1127140 0
	set MESG 0
	print ":getting tarrget"
	get_target CID_WAILER TEMP_TARGET
	printvar TEMP_TARGET
	scan_npc_cid LOC_WAILER_ROOM RESULTARRAY
	pushvar TEMP_TARGET
	print ":calling activate"
	call activateMinions
	return
